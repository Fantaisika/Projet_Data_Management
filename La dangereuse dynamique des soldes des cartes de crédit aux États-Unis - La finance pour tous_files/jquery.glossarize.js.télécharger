(function($){var pluginName='glossarizer',defaults={sourceURL:'',replaceTag:'abbr',lookupTagName:'p, ul, div',callback:null,replaceOnce:!1,replaceClass:'glossarizer_replaced'}
function Glossarizer(el,options){var base=this
base.el=el;base.$el=$(el)
base.options=$.extend({},defaults,options)
base.terms=[];base.excludes=[];base.replaced=[];base.regexOption=base.options.replaceOnce?'i':'ig';$.getJSON(this.options.sourceURL).then(function(data){base.glossary=data;if(!base.glossary.length||base.glossary.length==0)return;for(var i=0;i<base.glossary.length;i++){if(jQuery('.single-dictionary').length){var singleTitle=jQuery('.entry-title').text();if(base.glossary[i].term.indexOf(singleTitle)>=0){base.glossary[i].term=''}}
var terms=base.glossary[i].term.split(',');for(var j=0;j<terms.length;j++){var trimmed=terms[j].replace(/^\s+|\s+$/g,''),isExclusion=trimmed.indexOf('!');if(isExclusion==-1||isExclusion!=0){base.terms.push(trimmed)}else{base.excludes.push(trimmed.substr(1))}}}
base.wrapTerms()})}
Glossarizer.prototype={getDescription:function(term){var regex=new RegExp('(\\,|\\s*)'+this.clean(term).trim()+'(\\s*|\\,)$','i');for(var i=0;i<this.glossary.length;i++){if(this.glossary[i].term.match(regex)){return this.glossary[i].description.replace(/\"/gi,'&quot;')}}},clean:function(text){var reEscape=new RegExp('(\\'+['/','.','*','+','?','(',')','[',']','{','}','\\'].join('|\\')+')','g')
return text.replace(reEscape,'\\$1')},wrapTerms:function(){this.cleanedTerms=this.clean(this.terms.join('|'))
this.excludedTerms=this.clean(this.excludes.join('|'))
var nodes=this.el.querySelectorAll(this.options.lookupTagName)
for(var i=0;i<nodes.length;i++){this.traverser(nodes[i])}
if(this.options.callback)this.options.callback.call(this.$el)},traverser:function(node){var next,base=this;if(node.nodeType===1){if(node.nodeName=='A')
return;if(node=node.firstChild){do{next=node.nextSibling
if(node.className!=this.options.replaceClass){this.traverser(node)}}while(node=next)}}else if(node.nodeType===3){var temp=document.createElement('div'),data=node.data;var reEx=new RegExp('(?:^|\\b)('+this.excludedTerms+')(?!\\w)',base.regexOption);var re=new RegExp("(?:^\|[ \n\r\t.,'\"\+!?]+)("+this.cleanedTerms+")(?![^ \n\r\t,'\"\+!?-])",base.regexOption);if(re.test(data)){var excl=reEx.exec(data);data=data.replace(re,function(match,item,offset,string){if(base.options.replaceOnce&&inArrayIn(match,base.replaced)>=0){return match}
base.replaced.push(match);var ir=new RegExp('(?:^|\\b)'+base.clean(match)+'(?!\\w)'),result=ir.exec(data)
if(result){if(excl&&base.excludes.length){var id=offset,exid=excl.index,exl=excl.index+excl[0].length;if(exid<=id&&id<=exl){return match}else{var content='<'+base.options.replaceTag+' class="'+base.options.replaceClass+'" title="'+base.getDescription(match)+'">'+match+'</'+base.options.replaceTag+'>';return content}}else{return'<'+base.options.replaceTag+' class="'+base.options.replaceClass+'" title="'+base.getDescription(match)+'">'+match+'</'+base.options.replaceTag+'>'}}
return''});$(temp).html(data)
while(temp.firstChild){node.parentNode.insertBefore(temp.firstChild,node)}
node.parentNode.removeChild(node)}}},};var methods={destroy:function(){this.$el.removeData('plugin_'+pluginName);this.$el.find('.'+this.options.replaceClass).each(function(){var $this=$(this),text=$this.text();$this.replaceWith(text)})}}
Glossarizer.prototype=$.extend({},Glossarizer.prototype,methods)
$.fn[pluginName]=function(options){return this.each(function(){var $this=$(this),glossarizer=$this.data('plugin_'+pluginName);if(typeof options=="string"&&glossarizer&&methods.hasOwnProperty(options)){glossarizer[options].apply(glossarizer)}else{if(glossarizer)glossarizer.destroy.apply(glossarizer);$.data(this,'plugin_'+pluginName,new Glossarizer(this,options))}})}
function inArrayIn(elem,arr,i){if(typeof elem!=='string'){return $.inArray.apply(this,arguments)}
if(arr){var len=arr.length;i=i?(i<0?Math.max(0,len+i):i):0;elem=elem.toLowerCase();for(;i<len;i++){if(i in arr&&arr[i].toLowerCase()==elem){return i}}}
return-1}})(jQuery)